@* @model List<Planning.Models.Plan> *@

@{
	ViewData["Title"] = "Index";
}

<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Planning</title>
</head>

<body>
	<div>
		<a href="/Planning/AddPlan">Add Plan Page</a>
	</div>

	<br />
	<div id="allPlansDiv">
		<button id="getPlans">Get all plans</button>
		<div id="plans"></div>
	</div>

	<div id="singlePlansDiv">
		<button id="getSinglePlans">Get Plan</button>
		<input type="text" id="planId">
	</div>
	<h1>List of Plans</h1>
	<div id="plansData"></div>

	@section Scripts {
		<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>

		<script>
			//			var connection = new signalR.HubConnectionBuilder()
			//				.withUrl("https://localhost:7003/PlanningHub")
			//				.build();
			//
			//			connection.start().catch(function (err) {
			//				return console.error(err.toString());
			//			});
			//			console.log("connection -> ", connection);
			//
			//			connection.on("PlansReceived",
			//				data => {
			//					const container = document.getElementById('plans');
			//					data.forEach(plan => {
			//
			//						// Create elements
			//						const element = document.createElement('div');
			//						const header = document.createElement('h3');
			//						const date = document.createElement('p');
			//
			//						// Add API data
			//						header.innerText = plan.name + " Id: " + plan.id;
			//						date.innerText = plan.date;
			//
			//						// Add to container
			//						element.appendChild(header);
			//						element.appendChild(date);
			//						container.appendChild(element);
			//
			//					});
			//				});
			//
			//			connection.on("PlanByIdReceived",
			//				plan => {
			//
			//					console.log("Plan received: ", plan);
			//
			//					const container = document.getElementById('singlePlansDiv');
			//
			//					const element = document.createElement('div');
			//					const header = document.createElement('h3');
			//					const date = document.createElement('p');
			//
			//					// Add API data
			//					header.innerText = plan.plan.name + " Id: " + plan.plan.id;
			//					date.innerText = plan.plan.date;
			//
			//					// Add to container
			//					element.appendChild(header);
			//					element.appendChild(date);
			//					container.appendChild(element);
			//				});

			const getPlansBtn = document.getElementById("getPlans");
			const getSinglePlansBtn = document.getElementById("getSinglePlans");
			const idInput = document.getElementById("planId");

			getPlansBtn.addEventListener("click", getPlans);

			async function getPlans() {

				// Make GET request
				const response = await fetch('https://localhost:7241/api/Plans');

				// Check valid response
				if (response.ok) {

					// Deserialize response
					const plans = await response.json();

					// Log persons list
					plans.forEach(plan => {
						console.log(plan.id, plan.name, plan.date);

					});
					const html = plans.map(plan => {
						return `
						<div class="person">
								<p>${plan.id} - ${plan.name} - ${plan.date.split('T')[0]}</p>
						</div>
					  `;
					});

					// Display persons
					document.getElementById('plansData').innerHTML = html.join('');
				} else {

					console.log('Error retrieving persons');

				}

			}

			//			getPlansBtn.addEventListener("click",
			//				() => {
			//					//					fetch("/Plans",
			//					fetch("https://localhost:7241/api/Plans",
			//						{
			//							method: "GET"
			//						})
			//						.then(response => {
			//							if (response.ok) {
			//								console.log(response);
			//
			//								let data = response.json();
			//
			//								// Check if response is an array
			//								if (Array.isArray(data)) {
			//
			//									// Map each item to a Person object
			//									let plans = data.map(item => {
			//
			//										return {
			//											id: item.id,
			//											name: item.name,
			//											date: item.date
			//										};
			//									});
			//
			//									for (var i = 0; i < plans.length; i++) {
			//
			//										console.log(plans[i].id);
			//									}
			//								} else {
			//									console.log("error in response - ", response.state);
			//								}
			//							}
			//						})
			//						.catch(error => {
			//							console.error(error);
			//						});
			//				});

			getSinglePlansBtn.addEventListener("click",
				() => {
					var id = idInput.value;
					var encodedId = encodeURIComponent(id);
					//					var url = `/Planning/GetPlanById?id=${encodedId}`;

					if (id == "") {
						alert("Id value cannot be empty");
					} else {
						const url = `/Plans/${encodedId}`;

						fetch(url,
							{
								method: "GET",
								headers: {
									'Content-Type': 'application/json'
								}
							})
							.then(response => {
								if (response.ok) {

								} else {
									// handle error
								}
							})
							.catch(error => {
								console.error(error);
							});
						idInput.value = "";
					}
				});

		</script>
	}

</body>
</html>